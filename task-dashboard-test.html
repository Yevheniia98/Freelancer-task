<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task Dashboard Integration Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            border-left: 4px solid;
        }
        .success { border-color: #28a745; background: #d4edda; color: #155724; }
        .warning { border-color: #ffc107; background: #fff3cd; color: #856404; }
        .error { border-color: #dc3545; background: #f8d7da; color: #721c24; }
        .info { border-color: #17a2b8; background: #d1ecf1; color: #0c5460; }
        
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }
        .stat-number { font-size: 2em; font-weight: bold; margin: 10px 0; }
        .stat-label { opacity: 0.9; }
        
        .task-list {
            margin: 20px 0;
        }
        .task-item {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
        }
        .task-title { font-weight: bold; margin-bottom: 5px; }
        .task-meta { font-size: 0.9em; color: #6c757d; }
        .status-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
            margin-left: 10px;
        }
        .status-TODO { background: #fff3cd; color: #856404; }
        .status-IN_PROGRESS { background: #cce5ff; color: #004085; }
        .status-COMPLETED { background: #d4edda; color: #155724; }
        
        pre { background: #f8f9fa; padding: 15px; border-radius: 4px; overflow-x: auto; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ Task Dashboard Integration Test</h1>
        
        <div id="status" class="status info">
            Ready to test task dashboard integration
        </div>
        
        <div>
            <button onclick="setAuthToken()">1. Set Authentication Token</button>
            <button onclick="testStatistics()">2. Test Statistics API</button>
            <button onclick="testTasksList()">3. Test Tasks List</button>
            <button onclick="openTaskDashboard()">4. Open Task Dashboard</button>
        </div>
        
        <div id="statistics" style="display: none;">
            <h2>üìä Task Statistics</h2>
            <div id="stats-grid" class="stats-grid"></div>
        </div>
        
        <div id="tasks" style="display: none;">
            <h2>üìã Tasks List</h2>
            <div id="task-list" class="task-list"></div>
        </div>
        
        <div id="debug">
            <h2>üîç Debug Information</h2>
            <pre id="debug-info">Click buttons above to see debug information...</pre>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3030/api';
        const FRONTEND_URL = 'http://localhost:8080/task-dashboard';
        
        // Test user credentials
        const TEST_CREDENTIALS = {
            email: 'suprun.jen@gmail.com',
            password: '03101998Polo'
        };
        
        let authToken = null;
        
        function updateStatus(message, type = 'info') {
            const status = document.getElementById('status');
            status.className = `status ${type}`;
            status.textContent = message;
        }
        
        function updateDebug(info) {
            document.getElementById('debug-info').textContent = JSON.stringify(info, null, 2);
        }
        
        async function setAuthToken() {
            try {
                updateStatus('üîê Authenticating user...', 'info');
                
                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(TEST_CREDENTIALS)
                });
                
                const data = await response.json();
                updateDebug({ loginResponse: data });
                
                if (data.success && data.data && data.data.token) {
                    authToken = data.data.token;
                    
                    // Set token in localStorage for the frontend
                    localStorage.setItem('authToken', authToken);
                    localStorage.setItem('token', authToken);
                    
                    updateStatus(`‚úÖ Authentication successful! Token set for user: ${data.data.user.fullName}`, 'success');
                } else {
                    updateStatus('‚ùå Authentication failed - no token received', 'error');
                }
            } catch (error) {
                updateStatus(`‚ùå Authentication error: ${error.message}`, 'error');
                updateDebug({ authError: error.message });
            }
        }
        
        async function testStatistics() {
            if (!authToken) {
                updateStatus('‚ö†Ô∏è Please authenticate first', 'warning');
                return;
            }
            
            try {
                updateStatus('üìä Fetching task statistics...', 'info');
                
                const response = await fetch(`${API_BASE}/tasks/statistics`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                const data = await response.json();
                updateDebug({ statisticsResponse: data });
                
                if (data.success || data.totalTasks !== undefined) {
                    const stats = data.data || data;
                    displayStatistics(stats);
                    updateStatus('‚úÖ Statistics loaded successfully!', 'success');
                } else {
                    updateStatus('‚ùå Failed to load statistics', 'error');
                }
            } catch (error) {
                updateStatus(`‚ùå Statistics error: ${error.message}`, 'error');
                updateDebug({ statsError: error.message });
                
                // Show mock data as fallback
                const mockStats = {
                    totalTasks: 5,
                    completedTasks: 1,
                    inProgressTasks: 2,
                    pendingTasks: 2,
                    completionRate: 20.0,
                    dataSource: 'Mock Data (API not available)'
                };
                displayStatistics(mockStats);
                updateStatus('‚ö†Ô∏è Showing mock data - API not available', 'warning');
            }
        }
        
        function displayStatistics(stats) {
            const container = document.getElementById('stats-grid');
            container.innerHTML = `
                <div class="stat-card">
                    <div class="stat-number">${stats.totalTasks || 0}</div>
                    <div class="stat-label">Total Tasks</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.completedTasks || 0}</div>
                    <div class="stat-label">Completed</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.inProgressTasks || 0}</div>
                    <div class="stat-label">In Progress</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.completionRate || 0}%</div>
                    <div class="stat-label">Completion Rate</div>
                </div>
            `;
            document.getElementById('statistics').style.display = 'block';
        }
        
        async function testTasksList() {
            if (!authToken) {
                updateStatus('‚ö†Ô∏è Please authenticate first', 'warning');
                return;
            }
            
            try {
                updateStatus('üìã Fetching tasks list...', 'info');
                
                const response = await fetch(`${API_BASE}/tasks/my-tasks`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                const data = await response.json();
                updateDebug({ tasksResponse: data });
                
                if (data.success || data.tasks) {
                    const tasks = data.data?.tasks || data.tasks || [];
                    displayTasks(tasks);
                    updateStatus(`‚úÖ Loaded ${tasks.length} tasks successfully!`, 'success');
                } else {
                    updateStatus('‚ùå Failed to load tasks', 'error');
                }
            } catch (error) {
                updateStatus(`‚ùå Tasks error: ${error.message}`, 'error');
                updateDebug({ tasksError: error.message });
                
                // Show mock data as fallback
                const mockTasks = [
                    { _id: '1', title: 'Complete Project Setup', description: 'Set up initial structure', status: 'TODO', priority: 'high' },
                    { _id: '2', title: 'User Authentication', description: 'Login and registration', status: 'IN_PROGRESS', priority: 'high' },
                    { _id: '3', title: 'Database Schema', description: 'Design database', status: 'COMPLETED', priority: 'medium' }
                ];
                displayTasks(mockTasks);
                updateStatus('‚ö†Ô∏è Showing mock data - API not available', 'warning');
            }
        }
        
        function displayTasks(tasks) {
            const container = document.getElementById('task-list');
            container.innerHTML = tasks.map(task => `
                <div class="task-item">
                    <div class="task-title">
                        ${task.title}
                        <span class="status-badge status-${task.status}">${task.status}</span>
                    </div>
                    <div class="task-meta">
                        ${task.description} | Priority: ${task.priority} | Due: ${task.dueDate || 'No date'}
                    </div>
                </div>
            `).join('');
            document.getElementById('tasks').style.display = 'block';
        }
        
        function openTaskDashboard() {
            if (!authToken) {
                updateStatus('‚ö†Ô∏è Please authenticate first', 'warning');
                return;
            }
            
            updateStatus('üöÄ Opening Task Dashboard in new window...', 'info');
            window.open(FRONTEND_URL, '_blank');
        }
        
        // Auto-check if token exists
        window.onload = function() {
            const existingToken = localStorage.getItem('authToken') || localStorage.getItem('token');
            if (existingToken) {
                authToken = existingToken;
                updateStatus('üîë Found existing authentication token', 'success');
            }
        };
    </script>
</body>
</html>
